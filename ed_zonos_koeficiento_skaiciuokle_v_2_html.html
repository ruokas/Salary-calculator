<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zoninio Koeficiento Skaičiuoklė (V2 – triažas + apkrova)</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --muted: #94a3b8;     /* slate-400 */
      --text: #e5e7eb;      /* gray-200 */
      --accent: #22c55e;    /* green-500 */
      --accent-2: #60a5fa;  /* blue-400 */
      --danger: #ef4444;    /* red-500 */
      --card: #0b1220;      /* custom */
      --border: #1f2937;    /* gray-800 */
      --drag: #334155;      /* slate-600 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, var(--bg), #0b1020 60%, #0a0f1a);
      color: var(--text);
    }
    .container { max-width: 1140px; margin: 24px auto; padding: 16px; }
    .title { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .badge { padding: 4px 10px; border-radius: 999px; background: #1e293b; color: var(--muted); font-size: 12px; }
    .grid { display: grid; gap: 14px; }
    @media (min-width: 960px) { .grid-2 { grid-template-columns: 1.2fr 0.8fr; } }
    .card {
      background: radial-gradient(1200px 400px at 10% 0%, #0c1324, var(--card));
      border: 1px solid var(--border);
      border-radius: 16px; padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.02);
    }
    h1 { font-size: 24px; margin: 6px 0 2px; letter-spacing: 0.2px; }
    h2 { font-size: 16px; margin: 0 0 10px; color: var(--muted); font-weight: 600; letter-spacing: 0.2px; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="number"], input[type="date"], input[type="text"], select {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0b1324; color: var(--text); outline: none; transition: border-color .2s;
    }
    input[type="number"]:focus, input[type="date"]:focus, input[type="text"]:focus, select:focus { border-color: var(--accent-2); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .help { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .switch { display: inline-flex; align-items: center; gap: 8px; user-select: none; cursor: pointer; font-size: 13px; color: var(--muted); }
    .switch input { appearance: none; width: 38px; height: 22px; background: #152036; border-radius: 999px; position: relative; outline: none; transition: background .2s; }
    .switch input::after { content:""; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: transform .2s; }
    .switch input:checked { background: #1f7af8; }
    .switch input:checked::after { transform: translateX(16px); }

    .kpi { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; margin-top: 8px; }
    .kpi .item { padding: 12px; border-radius: 14px; border: 1px solid var(--border); background: #0c152b; }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .val { font-size: 20px; font-weight: 700; margin-top: 2px; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border:1px solid var(--border); background:#0c1324; }
    .accent { color: var(--accent); }
    .muted { color: var(--muted); }

    .actions { display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
    button { appearance: none; border: 1px solid var(--border); background: #0d1a33; color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; transition: transform .05s ease, background .2s, border-color .2s; }
    button:hover { background: #0f213f; border-color: #2b3a55; }
    button:active { transform: translateY(1px); }
    .primary { border-color: #2563eb; background: #0e1f3f; }
    .warn { border-color: #b91c1c; }

    .table { width:100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
    .table th, .table td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; }
    .table th { color: var(--muted); font-weight: 600; }

    .footer { margin-top: 18px; font-size: 12px; color: var(--muted); }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(3,6,23,0.65); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 50; }
    .modal.active { display: flex; }
    .dialog { width: min(980px, 96vw); background: radial-gradient(1000px 400px at 10% 0%, #0c1324, var(--card)); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .dialog h3 { margin: 6px 0 10px; font-size: 18px; }
    .dialog .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom: 8px; }
    .dialog .toolbar .spacer { flex: 1; }
    .icon-btn { width: 36px; height: 36px; border-radius: 10px; display:flex; align-items:center; justify-content:center; }
    .small { font-size: 12px; }

    /* Drag & Drop */
    .drag-row { cursor: grab; }
    .drag-row:active { cursor: grabbing; }
    .drag-handle { width: 16px; height: 16px; display:inline-block; margin-right:8px; background: linear-gradient(90deg, var(--drag) 33%, transparent 33%) 0 0/6px 2px repeat-y; border-radius:3px; }
    .drag-over { outline: 2px dashed var(--accent-2); outline-offset: -2px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">
      <h1>Zoninio Koeficiento Skaičiuoklė</h1>
      <span class="badge">V2 · triažas + apkrova · be kokybės rodiklių</span>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <h2>Įvestis</h2>
        <div class="row">
          <div>
            <label for="date">Data</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="shift">Pamaina</label>
            <select id="shift">
              <option value="D">Dieninė</option>
              <option value="N">Naktinė</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="zone">Zona</label>
            <div class="row" style="grid-template-columns: 1fr auto; gap:8px;">
              <select id="zone"></select>
              <button id="manageZones" type="button">Tvarkyti zonas</button>
            </div>
          </div>
          <div>
            <label for="capacity">Talpa C (pac./pam.)</label>
            <input id="capacity" type="number" min="0" step="1" placeholder="pvz. 16" />
            <div class="help">Keičiant zoną/pamainą įstatoma numatytoji talpa (galite perrašyti).</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="N">Pacientų N (zonoje per pamainą)</label>
            <input id="N" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="kmax">K<sub>max</sub> (lubos)</label>
            <input id="kmax" type="number" min="1" max="2" step="0.01" value="1.30" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="baseRateDoc">Bazinis gydytojo tarifas (€ / val.)</label>
            <input id="baseRateDoc" type="number" min="0" step="0.01" value="0" placeholder="pvz. 25.00" />
          </div>
          <div>
            <label for="baseRateNurse">Bazinis slaugytojo tarifas (€ / val.)</label>
            <input id="baseRateNurse" type="number" min="0" step="0.01" value="0" placeholder="pvz. 14.00" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="baseRateAssist">Bazinis padėjėjo tarifas (€ / val.)</label>
            <input id="baseRateAssist" type="number" min="0" step="0.01" value="0" placeholder="pvz. 9.00" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button id="saveRateTemplate">Įsiminti tarifų šabloną</button>
              <button id="loadRateTemplate">Užkrauti šabloną</button>
            </div>
            <div class="help">Tarifų šablonas saugomas vietoje (localStorage).</div>
          </div>
        </div>

        <div style="margin:10px 0 6px;">
          <label class="switch">
            <input id="linkN" type="checkbox" checked />
            <span>Naudoti N = ESI1+ESI2+ESI3+ESI4+ESI5</span>
          </label>
        </div>

        <div class="row-3">
          <div>
            <label for="esi1">ESI-1</label>
            <input id="esi1" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="esi2">ESI-2</label>
            <input id="esi2" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="esi3">ESI-3</label>
            <input id="esi3" type="number" min="0" step="1" value="0" />
          </div>
        </div>
        <div class="row-3">
          <div>
            <label for="esi4">ESI-4</label>
            <input id="esi4" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="esi5">ESI-5</label>
            <input id="esi5" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="help">Jei nėra triažo – palikite visur nulį.</div>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="reset">Išvalyti</button>
          <button id="copy">Kopijuoti rezultatą (JSON)</button>
        </div>
      </div>

      <div class="card">
        <h2>Rezultatai</h2>
        <div class="kpi">
          <div class="item">
            <div class="label">Santykis N/C</div>
            <div class="val" id="ratio">0.00</div>
            <div class="help">Apkrovos intervalas lemia V<sub>priedas</sub></div>
          </div>
          <div class="item">
            <div class="label">Aukštos skubos dalis S = (ESI1+ESI2)/N</div>
            <div class="val" id="sShare">0.00</div>
            <div class="help">Lemia A<sub>priedas</sub></div>
          </div>
        </div>

        <table class="table">
          <thead>
            <tr><th>Komponentas</th><th>Reikšmė</th><th>Pastaba</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>V<sub>priedas</sub> (apkrova)</td>
              <td id="vBonus">+0.00</td>
              <td>
                ≤0.8 → 0.00 · (0.8–1.0] → 0.05 · (1.0–1.25] → 0.10 · >1.25 → 0.15
              </td>
            </tr>
            <tr>
              <td>A<sub>priedas</sub> (triažas)</td>
              <td id="aBonus">+0.00</td>
              <td>
                ≤10% → 0.00 · (10–20]% → 0.05 · (20–30]% → 0.10 · >30% → 0.15
              </td>
            </tr>
            <tr>
              <td>K<sub>max</sub> (lubos)</td>
              <td id="kMaxCell">1.30</td>
              <td>Galinio koeficiento riba</td>
            </tr>
            <tr>
              <td class="accent">K<sub>zona</sub></td>
              <td class="accent" id="kZona">1.00</td>
              <td>min(1 + V + A, K<sub>max</sub>)</td>
            </tr>
          </tbody>
        </table>

        <h2 style="margin-top:14px;">Tarifai pagal rolę</h2>
        <table class="table">
          <thead>
            <tr><th>Rolė</th><th>Bazė (€/val.)</th><th>Koef. K<sub>zona</sub></th><th>Galutinis (€/val.)</th></tr>
          </thead>
          <tbody>
            <tr><td>Gydytojas</td><td id="baseDocCell">€0,00</td><td id="kDocCell">1,00</td><td class="accent" id="finalDocCell">€0,00</td></tr>
            <tr><td>Slaugytojas</td><td id="baseNurseCell">€0,00</td><td id="kNurseCell">1,00</td><td class="accent" id="finalNurseCell">€0,00</td></tr>
            <tr><td>Padėjėjas</td><td id="baseAssistCell">€0,00</td><td id="kAssistCell">1,00</td><td class="accent" id="finalAssistCell">€0,00</td></tr>
          </tbody>
        </table>

        <div class="footer">
          Patarimas: jei dažnai pasiekiate lubas, padidinkite talpą C arba sumažinkite priedų laiptelius.
        </div>
      </div>
    </div>
  </div>

  <!-- ZONŲ TVARKYMO MODALAS (drag&drop + grupės) -->
  <div class="modal" id="zoneModal" aria-hidden="true">
    <div class="dialog">
      <h3>Zonų tvarkymas</h3>
      <div class="help">Pridėkite, redaguokite, <strong>rikiuokite (drag&drop)</strong> ir grupuokite zonas. Pakeitimai saugomi šiame įrenginyje (<em>localStorage</em>).</div>
      <div class="toolbar" style="margin:10px 0;">
        <button id="addZone" class="icon-btn">+ Pridėti zoną</button>
        <div class="spacer"></div>
        <button id="defaultsZones" class="warn">Numatytosios zonos</button>
        <button id="closeZoneModal">Uždaryti</button>
        <button id="saveZonesBtn" class="primary">Išsaugoti</button>
      </div>
      <table class="table" style="margin-top:6px;">
        <thead>
          <tr>
            <th style="width:4%"></th>
            <th style="width:28%">Pavadinimas</th>
            <th style="width:14%">Kodas</th>
            <th style="width:14%">Grupė</th>
            <th style="width:14%">Talpa D</th>
            <th style="width:14%">Talpa N</th>
            <th style="width:12%">Šalinti</th>
          </tr>
        </thead>
        <tbody id="zoneTbody"></tbody>
      </table>
      <div class="help small">Pastaba: <strong>Kodas</strong> turi būti unikalus (pvz., RED, YEL, GRN). Grupę galite įvesti savo (pvz., „Suaugusiųjų“, „Vaikų“).</div>
    </div>
  </div>

  <script>
    // --- Zonų duomenys ---
    const DEFAULT_ZONES = [
      { id: 'RED',   name: 'Raudona (kritinė)',       group: 'Suaugusiųjų', cap: { D: 16, N: 12 } },
      { id: 'YEL',   name: 'Geltona (vidutinė)',      group: 'Suaugusiųjų', cap: { D: 22, N: 15 } },
      { id: 'GRN',   name: 'Žalia (mažesnė skuba)',   group: 'Suaugusiųjų', cap: { D: 28, N: 20 } },
      { id: 'TRIAGE',name: 'Triage/registracija',     group: 'Bendra',       cap: { D: 35, N: 24 } },
      { id: 'OBS',   name: 'Stebėjimo zona',          group: 'Bendra',       cap: { D: 14, N: 10 } },
      { id: 'PROCS', name: 'Procedūrų zona',          group: 'Bendra',       cap: { D: 12, N: 10 } },
      { id: 'PED',   name: 'Vaikų zona',              group: 'Vaikų',        cap: { D: 20, N: 14 } },
      { id: 'OTHER', name: 'Kita',                    group: 'Bendra',       cap: { D: 20, N: 16 } }
    ];

    const LS_KEY = 'ED_ZONES_V2';
    const LS_RATE_KEY = 'ED_RATE_TEMPLATE_V2';

    function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
    function sanitizeId(txt){ const s = (txt||'').toString().toUpperCase().replace(/[^A-Z0-9]+/g,'_').replace(/^_|_$/g,''); return s || 'ZONE_' + Math.random().toString(36).slice(2,6).toUpperCase(); }

    function loadZones(){ try { const j = localStorage.getItem(LS_KEY); if (j){ const arr = JSON.parse(j); if (Array.isArray(arr)) return arr; } } catch {} return clone(DEFAULT_ZONES); }
    function saveZones(zs){ try { localStorage.setItem(LS_KEY, JSON.stringify(zs)); } catch {} }

    let ZONES = loadZones();

    // --- Elementai ---
    const els = {
      date: document.getElementById('date'),
      shift: document.getElementById('shift'),
      zone: document.getElementById('zone'),
      capacity: document.getElementById('capacity'),
      N: document.getElementById('N'),
      kmax: document.getElementById('kmax'),
      baseRateDoc: document.getElementById('baseRateDoc'),
      baseRateNurse: document.getElementById('baseRateNurse'),
      baseRateAssist: document.getElementById('baseRateAssist'),
      linkN: document.getElementById('linkN'),
      esi1: document.getElementById('esi1'),
      esi2: document.getElementById('esi2'),
      esi3: document.getElementById('esi3'),
      esi4: document.getElementById('esi4'),
      esi5: document.getElementById('esi5'),
      ratio: document.getElementById('ratio'),
      sShare: document.getElementById('sShare'),
      vBonus: document.getElementById('vBonus'),
      aBonus: document.getElementById('aBonus'),
      kMaxCell: document.getElementById('kMaxCell'),
      kZona: document.getElementById('kZona'),
      baseDocCell: document.getElementById('baseDocCell'),
      kDocCell: document.getElementById('kDocCell'),
      finalDocCell: document.getElementById('finalDocCell'),
      baseNurseCell: document.getElementById('baseNurseCell'),
      kNurseCell: document.getElementById('kNurseCell'),
      finalNurseCell: document.getElementById('finalNurseCell'),
      baseAssistCell: document.getElementById('baseAssistCell'),
      kAssistCell: document.getElementById('kAssistCell'),
      finalAssistCell: document.getElementById('finalAssistCell'),
      reset: document.getElementById('reset'),
      copy: document.getElementById('copy'),
      manageZones: document.getElementById('manageZones'),
      zoneModal: document.getElementById('zoneModal'),
      zoneTbody: document.getElementById('zoneTbody'),
      addZone: document.getElementById('addZone'),
      saveZonesBtn: document.getElementById('saveZonesBtn'),
      defaultsZones: document.getElementById('defaultsZones'),
      closeZoneModal: document.getElementById('closeZoneModal'),
      saveRateTemplate: document.getElementById('saveRateTemplate'),
      loadRateTemplate: document.getElementById('loadRateTemplate')
    };

    // --- Pagalbinės ---
    function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function fmt(n, d=2){ return (Number.isFinite(n) ? n : 0).toFixed(d); }
    function money(n){ try{ return new Intl.NumberFormat('lt-LT',{style:'currency',currency:'EUR'}).format(n||0); }catch{ return `€${fmt(n)}`; } }

    // Grouped select render
    function renderZoneSelect(preserve){
      const prev = preserve ? els.zone.value : null;
      els.zone.innerHTML = '';
      const groups = {};
      ZONES.forEach(z => { const g = z.group || 'Kita'; (groups[g] ||= []).push(z); });
      Object.keys(groups).sort().forEach(g => {
        const og = document.createElement('optgroup'); og.label = g;
        groups[g].forEach(z => {
          const opt = document.createElement('option');
          opt.value = z.id; opt.textContent = z.name; opt.dataset.capacityD = z.cap?.D ?? 20; opt.dataset.capacityN = z.cap?.N ?? 16; og.appendChild(opt);
        });
        els.zone.appendChild(og);
      });
      if (prev && ZONES.some(z=>z.id===prev)) els.zone.value = prev;
      if (!els.zone.value && ZONES.length) els.zone.value = ZONES[0].id;
      setDefaultCapacity();
    }

    function setDefaultCapacity(){
      const id = els.zone.value; const s = els.shift.value;
      const z = ZONES.find(x=>x.id===id);
      const cap = z ? (s==='D' ? (z.cap?.D ?? 20) : (z.cap?.N ?? 16)) : 20;
      els.capacity.value = cap;
    }

    function openZoneModal(){ els.zoneModal.classList.add('active'); renderZoneEditor(); }
    function closeZoneModal(){ els.zoneModal.classList.remove('active'); }

    // Drag & Drop reorder helpers
    let dragIdx = null;
    function onDragStart(e){ dragIdx = Number(e.currentTarget.dataset.idx); e.dataTransfer.effectAllowed = 'move'; }
    function onDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drag-over'); }
    function onDragLeave(e){ e.currentTarget.classList.remove('drag-over'); }
    function onDrop(e){ e.preventDefault(); const targetIdx = Number(e.currentTarget.dataset.idx); e.currentTarget.classList.remove('drag-over'); if (!Number.isInteger(dragIdx) || !Number.isInteger(targetIdx) || dragIdx===targetIdx) return; const item = ZONES.splice(dragIdx,1)[0]; ZONES.splice(targetIdx,0,item); renderZoneEditor(); renderZoneSelect(true); }

    function renderZoneEditor(){
      els.zoneTbody.innerHTML = '';
      ZONES.forEach((z, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'drag-row';
        tr.setAttribute('draggable','true');
        tr.dataset.idx = idx;
        tr.addEventListener('dragstart', onDragStart);
        tr.addEventListener('dragover', onDragOver);
        tr.addEventListener('dragleave', onDragLeave);
        tr.addEventListener('drop', onDrop);
        tr.innerHTML = `
          <td><span class="drag-handle" title="Vilkite rikiavimui"></span></td>
          <td><input type="text" value="${z.name}" data-idx="${idx}" data-field="name" /></td>
          <td><input type="text" value="${z.id}" data-idx="${idx}" data-field="id" /></td>
          <td><input type="text" value="${z.group || ''}" data-idx="${idx}" data-field="group" placeholder="pvz., Suaugusiųjų" /></td>
          <td><input type="number" min="0" step="1" value="${z.cap?.D ?? 0}" data-idx="${idx}" data-field="capD" /></td>
          <td><input type="number" min="0" step="1" value="${z.cap?.N ?? 0}" data-idx="${idx}" data-field="capN" /></td>
          <td><button data-action="del" data-idx="${idx}">Šalinti</button></td>`;
        els.zoneTbody.appendChild(tr);
      });

      els.zoneTbody.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', (e)=>{
          const i = Number(e.target.getAttribute('data-idx'));
          const f = e.target.getAttribute('data-field');
          const v = e.target.value;
          if (!ZONES[i]) return;
          if (f==='name') ZONES[i].name = v;
          if (f==='id') ZONES[i].id = sanitizeId(v);
          if (f==='group') ZONES[i].group = v;
          if (f==='capD') { ZONES[i].cap = ZONES[i].cap || {}; ZONES[i].cap.D = toNum(v); }
          if (f==='capN') { ZONES[i].cap = ZONES[i].cap || {}; ZONES[i].cap.N = toNum(v); }
          renderZoneSelect(true);
        });
      });

      els.zoneTbody.querySelectorAll('button[data-action="del"]').forEach(btn => {
        btn.addEventListener('click', (e)=>{
          const i = Number(e.target.getAttribute('data-idx'));
          ZONES.splice(i,1);
          renderZoneEditor();
          renderZoneSelect(false);
        });
      });
    }

    function addZone(){
      const baseName = 'Nauja zona';
      let n = 1; let id;
      do { id = sanitizeId(baseName + ' ' + n); n++; } while (ZONES.some(z=>z.id===id));
      ZONES.push({ id, name: baseName, group: '', cap: { D: 20, N: 16 } });
      renderZoneEditor();
      renderZoneSelect(true);
    }

    function saveZonesAndClose(){
      // Validacija: unikalūs kodai
      const ids = new Set();
      for (const z of ZONES){
        if (!z.id) z.id = sanitizeId(z.name);
        if (ids.has(z.id)) { alert('Zonų kodai turi būti unikalūs. Dubliuotas: ' + z.id); return; }
        ids.add(z.id);
        z.cap = { D: toNum(z.cap?.D), N: toNum(z.cap?.N) };
        if (!z.name) z.name = z.id;
      }
      saveZones(ZONES);
      renderZoneSelect(true);
      closeZoneModal();
    }

    function resetToDefaults(){ if (confirm('Atstatyti numatytąsias zonas? Jūsų sąrašas bus pakeistas.')) { ZONES = clone(DEFAULT_ZONES); saveZones(ZONES); renderZoneEditor(); renderZoneSelect(false); } }

    // --- Tarifų šablonas ---
    function saveRateTemplate(){
      const payload = {
        doc: toNum(els.baseRateDoc.value),
        nurse: toNum(els.baseRateNurse.value),
        assist: toNum(els.baseRateAssist.value)
      };
      try { localStorage.setItem(LS_RATE_KEY, JSON.stringify(payload)); alert('Tarifų šablonas įsimintas.'); } catch {}
    }
    function loadRateTemplate(){
      try { const j = localStorage.getItem(LS_RATE_KEY); if (j){ const t = JSON.parse(j); if (t){ els.baseRateDoc.value = t.doc ?? 0; els.baseRateNurse.value = t.nurse ?? 0; els.baseRateAssist.value = t.assist ?? 0; compute(); return; } } } catch {}
      alert('Nerasta išsaugoto šablono.');
    }

    // --- Skaičiavimai ---
    function compute(){
      const C = Math.max(0, toNum(els.capacity.value));
      const kMax = Math.min(2, Math.max(1, toNum(els.kmax.value)));
      const baseDoc = Math.max(0, toNum(els.baseRateDoc.value));
      const baseNurse = Math.max(0, toNum(els.baseRateNurse.value));
      const baseAssist = Math.max(0, toNum(els.baseRateAssist.value));
      let n1 = Math.max(0, toNum(els.esi1.value));
      let n2 = Math.max(0, toNum(els.esi2.value));
      let n3 = Math.max(0, toNum(els.esi3.value));
      let n4 = Math.max(0, toNum(els.esi4.value));
      let n5 = Math.max(0, toNum(els.esi5.value));

      let N = Math.max(0, toNum(els.N.value));
      if (els.linkN.checked){ N = n1 + n2 + n3 + n4 + n5; els.N.value = N; els.N.disabled = true; } else els.N.disabled = false;

      let ratio = 0; if (C > 0) ratio = N / C;
      let V = 0; if (ratio <= 0.8) V = 0; else if (ratio <= 1.0) V = 0.05; else if (ratio <= 1.25) V = 0.10; else V = 0.15;

      const high = n1 + n2; const S = N > 0 ? high / N : 0;
      let A = 0; if (S <= 0.10) A = 0; else if (S <= 0.20) A = 0.05; else if (S <= 0.30) A = 0.10; else A = 0.15;

      const K = Math.min(1 + V + A, kMax);
      const finalDoc = baseDoc * K;
      const finalNurse = baseNurse * K;
      const finalAssist = baseAssist * K;

      els.ratio.textContent = fmt(ratio);
      els.sShare.textContent = fmt(S);
      els.vBonus.textContent = `+${V.toFixed(2)}`;
      els.aBonus.textContent = `+${A.toFixed(2)}`;
      els.kMaxCell.textContent = kMax.toFixed(2);
      els.kZona.textContent = K.toFixed(2);

      els.baseDocCell.textContent = money(baseDoc);
      els.kDocCell.textContent = K.toFixed(2);
      els.finalDocCell.textContent = money(finalDoc);

      els.baseNurseCell.textContent = money(baseNurse);
      els.kNurseCell.textContent = K.toFixed(2);
      els.finalNurseCell.textContent = money(finalNurse);

      els.baseAssistCell.textContent = money(baseAssist);
      els.kAssistCell.textContent = K.toFixed(2);
      els.finalAssistCell.textContent = money(finalAssist);

      return {
        date: els.date.value || null,
        shift: els.shift.value,
        zone: els.zone.value,
        zone_label: (ZONES.find(z=>z.id===els.zone.value)?.name) || els.zone.value,
        capacity: C,
        N,
        ESI: { n1, n2, n3, n4, n5 },
        ratio: Number(fmt(ratio)),
        S: Number(fmt(S)),
        V_bonus: Number(V.toFixed(2)),
        A_bonus: Number(A.toFixed(2)),
        K_max: Number(kMax.toFixed(2)),
        K_zona: Number(K.toFixed(2)),
        base_rates: { doctor: Number(baseDoc.toFixed(2)), nurse: Number(baseNurse.toFixed(2)), assistant: Number(baseAssist.toFixed(2)) },
        final_rates: { doctor: Number(finalDoc.toFixed(2)), nurse: Number(finalNurse.toFixed(2)), assistant: Number(finalAssist.toFixed(2)) }
      };
    }

    function resetAll(){
      els.date.value = ''; els.shift.value = 'D';
      if (!ZONES.length) ZONES = clone(DEFAULT_ZONES);
      renderZoneSelect(false);
      els.N.value = 0; els.kmax.value = 1.30; els.linkN.checked = true;
      els.esi1.value = 0; els.esi2.value = 0; els.esi3.value = 0; els.esi4.value = 0; els.esi5.value = 0;
      // bandome užkrauti tarifų šabloną
      try { const j = localStorage.getItem(LS_RATE_KEY); if (j){ const t = JSON.parse(j); els.baseRateDoc.value = t.doc ?? 0; els.baseRateNurse.value = t.nurse ?? 0; els.baseRateAssist.value = t.assist ?? 0; } else { els.baseRateDoc.value = 0; els.baseRateNurse.value = 0; els.baseRateAssist.value = 0; } } catch { els.baseRateDoc.value = 0; els.baseRateNurse.value = 0; els.baseRateAssist.value = 0; }
      compute();
    }

    // --- Įvykiai ---
    ['input','change'].forEach(evt => { ['date','shift','zone','capacity','N','kmax','baseRateDoc','baseRateNurse','baseRateAssist','linkN','esi1','esi2','esi3','esi4','esi5'].forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener(evt, compute); }); });
    document.getElementById('shift').addEventListener('change', setDefaultCapacity);
    document.getElementById('zone').addEventListener('change', setDefaultCapacity);
    document.getElementById('reset').addEventListener('click', (e)=>{ e.preventDefault(); resetAll(); });
    document.getElementById('copy').addEventListener('click', (e)=>{ e.preventDefault(); const payload = compute(); const txt = JSON.stringify(payload, null, 2); navigator.clipboard.writeText(txt).then(()=>{ document.getElementById('copy').textContent = 'Nukopijuota ✓'; setTimeout(()=> document.getElementById('copy').textContent = 'Kopijuoti rezultatą (JSON)', 1400); }).catch(()=>{ alert('Nepavyko nukopijuoti. Pažymėkite ir kopijuokite rankiniu būdu.'); }); });

    // Zonų modalas
    els.manageZones.addEventListener('click', openZoneModal);
    els.addZone.addEventListener('click', addZone);
    els.saveZonesBtn.addEventListener('click', saveZonesAndClose);
    els.defaultsZones.addEventListener('click', resetToDefaults);
    els.closeZoneModal.addEventListener('click', closeZoneModal);

    // Tarifų šablonai
    els.saveRateTemplate.addEventListener('click', (e)=>{ e.preventDefault(); saveRateTemplate(); });
    els.loadRateTemplate.addEventListener('click', (e)=>{ e.preventDefault(); loadRateTemplate(); });

    // Init
    renderZoneSelect(false);
    resetAll();
  </script>
</body>
</html>
